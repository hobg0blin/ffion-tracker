# Ffion Tracker - Project Context

## Overview

Ffion Tracker is an ATProto-based application for tracking a cat named Ffion using automated computer vision. The system uses YOLO (YOLOv8) to detect cats via webcam, captures images, generates descriptions, and posts them to an ATProto Personal Data Server (PDS).

## Project Architecture

### Components

1. **Node.js Server** (WSL/Linux) - `server.js`
   - Express-based API server
   - OAuth authentication with ATProto
   - Persistent session storage using SQLite
   - Image upload and posting to PDS
   - Browser-based login flow

2. **Python Cat Detector** (Windows or Linux)
   - `cat_detector.py` - Linux/Mac version
   - `cat_detector_windows.py` - Windows version with DirectShow support
   - Uses YOLOv8 for cat detection (COCO class ID 15)
   - Camera selection interface
   - Posts to Node.js server via HTTP

3. **Database** - SQLite (`ffion-tracker.db`)
   - OAuth state storage
   - OAuth session storage with automatic token refresh

### Data Flow

```
Windows Python Script → Webcam → YOLO Detection → Image Capture
                                                        ↓
                                              Generate Description
                                                        ↓
                                    POST to localhost:3000/ffion/status
                                                        ↓
WSL Node.js Server → Authenticate → Upload to ATProto PDS
                                                        ↓
                                    atproto.bront.rodeo PDS
```

## User Information

- **ATProto Handle**: `brent.atproto.bront.rodeo`
- **PDS URL**: `https://atproto.bront.rodeo`
- **DID**: `did:plc:crwugtsporw4ixhqqyul4km6` (hardcoded in server.js for display)
- **Environment**: WSL (Windows Subsystem for Linux)

## Development Environment

- **OS**: WSL2 on Windows
- **Node.js**: Modern version with ES modules (`"type": "module"` in package.json)
- **Python**: Version 3.x with cv2, ultralytics, torch, etc.
- **Webcam Access**: Windows-side only (WSL doesn't support direct webcam access)

## Privacy & Security

**IMPORTANT**: The cat detector includes dual privacy safeguards to prevent capturing/posting images of people:

### Privacy Filter #1: YOLO Person Detection
- Detects both cats (class ID 15) and persons (class ID 0)
- **Skips frames where both person and cat are detected**
- Displays "PRIVACY: Person detected" warning on video feed
- No image is saved or processed

### Privacy Filter #2: Moondream Description Check
- After image description is generated, checks for person-related words
- Keywords: person, people, human, man, woman, someone, individual, owner, lady, gentleman, boy, girl, child, adult
- **Does not post to server if person mentioned in description**
- Image is saved locally but NOT uploaded to PDS
- Console shows: "⚠ Privacy filter: Description mentions person, skipping post"

### Defense-in-Depth
Both filters work independently:
1. First filter catches obvious cases where YOLO detects a person
2. Second filter catches cases where YOLO missed the person but Moondream describes one
3. This dual-layer approach minimizes false negatives

## User Preferences & Guidelines

### Git Commits

**IMPORTANT**: When creating commits, use this format:

```bash
git commit -m "Brief description of change

commit generated by Claude Code"
```

- Use one-line commit messages (brief, descriptive)
- Always include "commit generated by Claude Code" on a new line after the message
- DO NOT include Anthropic email or other co-author format
- Create commits at each major milestone/feature completion

### Maintaining This Documentation

**IMPORTANT**: After implementing any feature or making significant changes:

1. Update the relevant sections in this CLAUDE.md file
2. Add a brief summary to the "Recent Changes" section (see bottom of file)
3. Include the date and what was changed
4. Commit the CLAUDE.md updates along with your feature

This helps future Claude instances understand the current state of the project.

### Code Style

- No emojis unless explicitly requested
- Clear, concise comments
- Professional tone
- Security-conscious (don't commit secrets, use .gitignore properly)

### File Permissions

- Project files may be owned by root initially
- If permission errors occur, suggest: `sudo chown -R $USER:$USER /home/brent/projects/ffion-tracker`
- Use sudo for npm install when needed

## Project Structure

```
ffion-tracker/
├── server.js                    # Main Express server with OAuth
├── auth-storage.js              # SQLite-based session storage
├── oauth-client.js              # OAuth client configuration
├── lexicons.js                  # ATProto lexicon loader
├── cat_detector.py              # Linux/Mac cat detector
├── cat_detector_windows.py      # Windows cat detector with camera selection
├── requirements.txt             # Python dependencies
├── package.json                 # Node.js dependencies
├── cookies.txt                  # Session cookie (gitignored)
├── ffion-tracker.db            # SQLite database (gitignored)
├── .gitignore                   # Includes: *.db, cookies.txt, detected_cats/, *.pt, .venv/, .env
├── lexicons/com/ffion/          # ATProto lexicon definitions
│   ├── status.json              # Main status record type
│   ├── eating.json              # State: eating
│   ├── zoomies.json            # State: zoomies
│   ├── playing.json            # State: playing
│   ├── sleeping.json           # State: sleeping
│   └── listStatuses.json       # Query definition
└── detected_cats/               # Saved cat images (gitignored)
```

## Key Features Implemented

### 1. Persistent OAuth Sessions
- Sessions stored in SQLite (`oauth_sessions` table)
- Automatic token refresh
- No need to re-authenticate after server restarts
- Browser-based login flow at `/login`

### 2. Cat Detection
- YOLOv8 nano model for speed
- Confidence threshold: 0.5
- 60-second cooldown between detections
- Camera selection interface (scans indices 0-10)
- Only processes every 10th frame for CPU efficiency
- **Dual privacy filters**: Rejects frames with people detected (YOLO + Moondream)

### 3. Image Description
- Uses **Moondream2** vision model for image captioning
- Model: `vikhyatk/moondream2` (revision 2024-08-26)
- Lightweight 1.6B parameter model optimized for CPU inference
- Uses Moondream's `query()` API method
- Prompt: "Describe what this cat is doing in one short sentence."
- Automatically uses GPU if available, falls back to CPU
- Descriptions limited to 100 characters
- Fallback to simple message on error
- State is then determined from description keywords
- **Requires**: pyvips and libvips (see installation instructions)

### 4. State Mapping
- `com.ffion.eating` - Keywords: eat, food, dinner, breakfast, treats
- `com.ffion.sleeping` - Keywords: sleep, nap, rest, yawn
- `com.ffion.playing` - Keywords: play, energy, hunt
- `com.ffion.zoomies` - Keywords: zoom, mischief, midnight

### 5. Frontend Status Viewer
- Public page at `/` displays cat statuses with images
- Chronological navigation with Previous/Next buttons
- "Latest" button to jump back to most recent status
- Status counter showing current position (e.g., "Status 1 of 42")
- Fetches up to 100 recent statuses from PDS
- Navigation via query parameter `?index=N`
- **Delete button** with confirmation dialog to remove unwanted statuses
  - Requires authentication (uses session cookie)
  - Permanently deletes from PDS (safety feature for privacy filter failures)

## Setup Instructions

### First-Time Setup

1. **Install Node.js dependencies:**
   ```bash
   npm install
   ```

2. **Start the server:**
   ```bash
   node server.js
   ```

3. **Authenticate (browser):**
   - Visit http://localhost:3000/login (Windows) or http://127.0.0.1:3000/login (WSL)
   - Enter handle: `brent.atproto.bront.rodeo`
   - Complete OAuth flow
   - Visit `/get-cookie` to get session cookie
   - Create `cookies.txt` file in project root

4. **Install Python dependencies (on Windows):**
   ```bash
   pip install -r requirements.txt
   ```
   Note: pyvips should install automatically with its dependencies

5. **Run cat detector (on Windows):**
   ```bash
   python cat_detector_windows.py
   ```

### Configuration

**Python Script Configuration:**
```python
CONFIDENCE_THRESHOLD = 0.5    # Cat detection confidence
COOLDOWN_SECONDS = 60         # Time between detections
SERVER_URL = "http://localhost:3000/ffion/status"
```

**Server Configuration:**
- Port: 3000 (hardcoded in multiple places)
- Cookie secret: In server.js (development only)
- Database: `./ffion-tracker.db`

## API Endpoints

### Public Endpoints
- `GET /` - View latest Ffion status (public display page)
- `GET /login` - Browser login form
- `GET /client-metadata.json` - OAuth client metadata

### OAuth Endpoints
- `POST /login` - Initiate OAuth flow (JSON)
- `GET /oauth/callback` - OAuth callback handler
- `GET /get-cookie` - Get session cookie for Python script
- `POST /logout` - Clear session
- `GET /session` - Check authentication status

### Authenticated Endpoints
- `POST /ffion/status` - Post cat status with image
  - Multipart form data
  - Fields: `state` (required), `text` (optional), `image` (optional file)
  - Requires `ffion_sid` cookie
- `DELETE /ffion/status/:rkey` - Delete a cat status from PDS
  - Requires `ffion_sid` cookie
  - Permanently removes record from PDS
  - Used by frontend delete button

### Legacy Local Endpoints (in-memory, for testing)
- `POST /xrpc/com.atproto.repo.createRecord`
- `GET /xrpc/com.atproto.repo.listRecords`
- `GET /xrpc/com.atproto.repo.getRecord`

## Testing & Debugging

### Check PDS Records
```bash
# Get DID
curl "https://atproto.bront.rodeo/xrpc/com.atproto.identity.resolveHandle?handle=brent.atproto.bront.rodeo"

# List records
curl "https://atproto.bront.rodeo/xrpc/com.atproto.repo.listRecords?repo=did:plc:crwugtsporw4ixhqqyul4km6&collection=com.ffion.status&limit=50"

# Get image blob
curl "https://atproto.bront.rodeo/xrpc/com.atproto.sync.getBlob?did=did:plc:crwugtsporw4ixhqqyul4km6&cid=<CID>" -o image.jpg
```

### Check Session
```bash
curl http://127.0.0.1:3000/session -b "ffion_sid=<cookie_value>"
```

### Post Status Manually
```bash
curl -X POST http://127.0.0.1:3000/ffion/status \
  -H "Content-Type: application/json" \
  -b "ffion_sid=<cookie_value>" \
  -d '{"state": "com.ffion.playing", "text": "Test status"}'
```

## Known Issues & Limitations

1. **WSL Webcam Access**: WSL doesn't support direct webcam access. Solution: Run Python script on Windows host, Node.js server in WSL.

2. **Vision Model Performance**: Moondream runs on CPU by default which may be slow. GPU recommended for better performance.

3. **State Classification**: Currently uses keyword matching on descriptions. Future: Use lightweight LLM for better state classification.

4. **Camera Detection**: Scans indices 0-10. If camera is at higher index, increase range in `list_available_cameras()`.

5. **Session Persistence**: Sessions stored in SQLite but database file is gitignored. Backup if needed.

6. **Cookie Security**: Development cookie secret is hardcoded. Use environment variable in production.

7. **Firefox Cookie Issue**: Firefox treats `localhost` and `127.0.0.1` as different domains. **Use `http://127.0.0.1:3000` consistently** for login and frontend. If you log in on `localhost` but visit frontend on `127.0.0.1` (or vice versa), cookies won't work.

## Future Enhancements

- [ ] Use lightweight LLM for state classification (Phi-3 or TinyLlama)
- [ ] Support multiple cats with identification
- [ ] Activity tracking and analytics dashboard
- [ ] Real-time notifications (push/email)
- [ ] Mobile app integration
- [ ] Video clip recording on detection
- [ ] Integration with other ATProto apps
- [ ] Bluesky post creation with cat updates
- [ ] Fine-tune Moondream on cat-specific imagery

## ATProto/Lexicon Notes

### Custom Lexicons

The project defines custom lexicons under the `com.ffion` namespace:

- **com.ffion.status** (Record): Main status type with state, text, image, and timestamp
- **com.ffion.eating**, **com.ffion.zoomies**, **com.ffion.playing**, **com.ffion.sleeping** (Tokens): State definitions
- **com.ffion.listStatuses** (Query): List statuses query

These lexicons follow ATProto conventions and are validated on the server side.

### Image Handling

Images are uploaded as blobs using `com.atproto.repo.uploadBlob`, then referenced in the status record. The blob reference includes:
- `$type`: "blob"
- `ref`: CID (Content Identifier)
- `mimeType`: "image/jpeg"
- `size`: bytes

## Troubleshooting

### "No cameras found"
- Check camera is connected and not in use
- Try different USB port
- Verify camera works in other applications
- Windows: Check Privacy settings → Camera permissions

### "Could not open webcam"
- Another application may be using the camera
- Try different camera index
- Restart computer if driver issues

### "Permission denied" errors
- Run: `sudo chown -R $USER:$USER /home/brent/projects/ffion-tracker`
- For npm: Use `sudo npm install` if needed

### "OAuth failed" / "Session invalid"
- Re-authenticate via `/login`
- Check PDS is accessible: `curl https://atproto.bront.rodeo`
- Verify handle is correct
- Check cookies.txt format

### "Failed to write to PDS"
- Check network connectivity to PDS
- Verify OAuth session is still valid (`/session` endpoint)
- Check PDS logs for errors
- Ensure lexicons are properly registered

## Development Tips

1. **Testing without cat**: Temporarily change `CAT_CLASS_ID` to detect other objects (e.g., 0 for person)

2. **Faster detection**: Reduce cooldown to 5-10 seconds during testing

3. **Debug mode**: Add `verbose=True` to YOLO initialization for detailed detection output

4. **Server logs**: Watch server console for OAuth and upload errors

5. **Database inspection**: Use `sqlite3 ffion-tracker.db` to inspect sessions

## References

- ATProto Documentation: https://atproto.com/
- YOLO Documentation: https://docs.ultralytics.com/
- OpenCV Documentation: https://docs.opencv.org/
- Node.js OAuth Client: @atproto/oauth-client-node

---

## Recent Changes

### 2025-10-16 - Initial Implementation
- Added SQLite-based persistent OAuth session storage
- Created browser-based login flow with `/login` page
- Implemented Python cat detector with YOLO
- Created Windows-compatible version with camera selection
- Added comprehensive project documentation (this file)
- Added chronological navigation to frontend status viewer (Previous/Next/Latest buttons)
- Integrated Moondream2 vision model for real image descriptions (replaces time-based heuristic)

### 2025-10-17 - Privacy Filters
- Added dual privacy safeguards to prevent capturing/posting images with people
- Filter #1: YOLO person detection (class ID 0) - skips frames with both person and cat
- Filter #2: Moondream description check - blocks posts if person mentioned in description
- Both filters work independently for defense-in-depth
- Updated both cat_detector.py and cat_detector_windows.py

### 2025-10-17 - Delete Feature
- Added DELETE endpoint: `DELETE /ffion/status/:rkey` for removing statuses from PDS
- Added red "Delete This Status" button to frontend with confirmation dialog
- Safety feature to manually remove any images that slip through privacy filters
- Requires authentication via session cookie
- Redirects to homepage after successful deletion

### 2025-10-17 - Moondream API Fix
- Fixed image description generation to use proper Moondream `query()` API method
- Updated to use `model.query(image, prompt)["answer"]` instead of deprecated methods
- Added libvips installation instructions for Windows
- Fixed PhiForCausalLM AttributeError by using correct API
- Updated both cat_detector.py and cat_detector_windows.py

---

Last Updated: 2025-10-17
Project Version: 1.3.0
